<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>预约管理</title>
  <style>
    :root {
      /* 管理员专用色彩系统 */
      --admin-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --admin-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --admin-accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --admin-warm: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    * { box-sizing: border-box; }
    
    html, body { 
      margin: 0; 
      padding: 0; 
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.3) 0%, transparent 50%),
        linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text-primary); 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    /* 动态背景效果 */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
      animation: float 20s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(1deg); }
    }
    
    .container { 
      max-width: 1200px; 
      margin: 32px auto; 
      padding: 0 20px; 
      position: relative;
      z-index: 1;
    }
    
    .card { 
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 24px; 
      box-shadow: var(--shadow-soft);
      padding: 32px; 
      margin-bottom: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }
    
    h1 { 
      font-size: 28px; 
      margin: 0 0 16px; 
      background: var(--admin-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    
    label { 
      display: block; 
      font-size: 14px; 
      color: var(--text-secondary); 
      margin: 16px 0 8px; 
      font-weight: 500;
    }
    
    input, select { 
      width: 100%; 
      box-sizing: border-box; 
      font-size: 16px; 
      padding: 16px 20px; 
      border-radius: 16px; 
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      outline: none; 
      transition: all 0.3s ease;
      color: var(--text-primary);
    }
    
    input:focus, select:focus {
      border-color: rgba(102, 126, 234, 0.5);
      background: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .row { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 20px; 
    }
    
    .btn { 
      display: inline-flex; 
      align-items: center; 
      gap: 10px; 
      border: 0; 
      border-radius: 16px; 
      padding: 16px 24px; 
      background: var(--admin-primary);
      color: #fff; 
      cursor: pointer; 
      font-weight: 600; 
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
    }
    
    th, td { 
      padding: 16px 12px; 
      border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
      font-size: 14px; 
      text-align: left;
    }
    
    th {
      background: var(--admin-primary);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .status-select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .right { 
      text-align: right; 
    }
    
    /* 统计仪表板样式 */
    .stats-dashboard {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
      border-color: rgba(102, 126, 234, 0.3);
    }
    
    .stat-card:hover::before {
      left: 100%;
    }
    
    .stat-card:active {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0 0 12px;
      font-weight: 500;
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: 700;
      background: var(--admin-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    
    /* 操作按钮组样式 */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin: 16px 0;
    }
    
    .action-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .action-btn.confirm {
      background: var(--admin-accent);
      color: white;
    }
    
    .action-btn.start {
      background: var(--admin-secondary);
      color: white;
    }
    
    .action-btn.complete {
      background: var(--admin-warm);
      color: white;
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
      .container { padding: 0 16px; }
      .card { padding: 24px; }
      .row { grid-template-columns: 1fr; gap: 16px; }
      h1 { font-size: 24px; }
      table { font-size: 12px; }
      th, td { padding: 12px 8px; }
      
      .stats-dashboard {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="login-card" style="display: none;">
      <h1>管理员登录</h1>
      <div style="margin-bottom: 12px;">
        <label>邮箱</label>
        <input id="admin-email" type="email" value="340365946@qq.com" readonly />
      </div>
      <div style="margin-bottom: 12px;">
        <label>密码</label>
        <input id="admin-password" type="password" value="MeiRong@123" />
      </div>
      <button id="btn-login" class="btn">登录</button>
      <div id="login-msg" style="margin-top: 8px;"></div>
    </div>

    <div class="card" id="loading-card">
      <h1>正在进入管理系统...</h1>
      <div id="loading-msg" style="margin-top: 8px; color: #666;">正在自动登录，请稍候...</div>
    </div>

    <div class="card" id="admin-panel" style="display: none;">
      <h1>预约管理系统</h1>
      
      <!-- 工作概览统计 -->
      <div class="stats-dashboard">
        <div class="stat-card">
          <h3>今日工作</h3>
          <div class="stat-number" id="today-stats">0</div>
        </div>
        <div class="stat-card">
          <h3>本周完成</h3>
          <div class="stat-number" id="week-stats">0</div>
        </div>
        <div class="stat-card">
          <h3>本月完成</h3>
          <div class="stat-number" id="month-stats">0</div>
        </div>
      </div>
      
      
      <div class="row">
        <div>
          <label>状态</label>
          <select id="status">
            <option value="">全部</option>
            <option value="pending">待处理</option>
            <option value="confirmed">已确认</option>
            <option value="in_progress">进行中</option>
            <option value="completed">已完成</option>
            <option value="cancelled">已取消</option>
          </select>
        </div>
        <div>
          <label>项目</label>
          <input id="service" placeholder="如：面部护理" />
        </div>
        <div>
          <label>开始时间</label>
          <input id="start" type="datetime-local" />
        </div>
        <div>
          <label>结束时间</label>
          <input id="end" type="datetime-local" />
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <button id="btn-search" class="btn">查询</button>
        <button id="btn-refresh-stats" class="btn">刷新统计</button>
        <a href="index.html" class="btn" style="text-decoration:none;">返回用户页</a>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>客户</th>
            <th>电话</th>
            <th>项目</th>
            <th>预约时间</th>
            <th>状态</th>
            <th>备注</th>
            <th>工作流程</th>
            <th class="right">操作</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://yxumytufdjardhwlrexr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4dW15dHVmZGphcmRod2xyZXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NDQ2MjAsImV4cCI6MjA3NDEyMDYyMH0.v4uyS0SKzy92KKmG6JfYNLZyFf1YY7Q_QxXmy5_9uMU";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id) => document.getElementById(id);
    const fmt = (ts) => new Date(ts).toLocaleString();
    
    // 状态映射：英文到中文
    const statusMap = {
      'pending': '待处理',
      'confirmed': '已确认',
      'in_progress': '进行中',
      'completed': '已完成',
      'cancelled': '已取消'
    };
    
    // 获取状态的中文显示文本
    const getStatusText = (status) => statusMap[status] || status;
    
    // 状态转换规则
    const statusFlow = {
      'pending': ['confirmed', 'cancelled'],
      'confirmed': ['in_progress', 'cancelled'],
      'in_progress': ['completed'],
      'completed': [],
      'cancelled': []
    };
    
    // 获取可执行的操作
    function getAvailableActions(currentStatus) {
      return statusFlow[currentStatus] || [];
    }
    
    // 记录操作历史
    async function recordOperation(appointmentId, actionType, fromStatus, toStatus, notes = '') {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const { error } = await supabase
          .from('operation_history')
          .insert({
            appointment_id: appointmentId,
            operator_id: user.id,
            action_type: actionType,
            from_status: fromStatus,
            to_status: toStatus,
            notes: notes
          });
        
        if (error) {
          console.error('记录操作历史失败:', error);
        }
      } catch (err) {
        console.error('记录操作历史异常:', err);
      }
    }

    // 自动登录功能
    async function autoLogin() {
      console.log('开始自动登录...');
      el('loading-msg').textContent = '正在连接服务器...';
      
      try {
        // 使用管理员账号自动登录
        const { data, error } = await supabase.auth.signInWithPassword({
          email: '340365946@qq.com',
          password: 'MeiRong@123'
        });
        
        if (error) {
          console.error('自动登录失败:', error);
          el('loading-msg').innerHTML = `<span style="color: red;">自动登录失败：${error.message}</span>`;
          
          // 显示手动登录界面
          el('loading-card').style.display = 'none';
          el('login-card').style.display = 'block';
          return false;
        }
        
        console.log('自动登录成功:', data.user);
        el('loading-msg').textContent = '登录成功，正在加载数据...';
        
        // 隐藏加载界面，显示管理面板
        el('loading-card').style.display = 'none';
        el('admin-panel').style.display = 'block';
        
        // 登录成功后自动查询数据和统计
        await query();
        await loadStatistics();
        
        console.log('管理员界面加载完成');
        return true;
        
      } catch (err) {
        console.error('自动登录异常:', err);
        el('loading-msg').innerHTML = `<span style="color: red;">登录异常：${err.message}</span>`;
        
        // 显示手动登录界面
        el('loading-card').style.display = 'none';
        el('login-card').style.display = 'block';
        return false;
      }
    }

    // 手动登录功能（备用）
    el('btn-login').addEventListener('click', async () => {
      const email = el('admin-email').value;
      const password = el('admin-password').value;
      
      el('login-msg').textContent = '登录中...';
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });
        
        if (error) {
          el('login-msg').innerHTML = `<span style="color: red;">登录失败：${error.message}</span>`;
          return;
        }
        
        el('login-msg').innerHTML = '<span style="color: green;">登录成功</span>';
        el('login-card').style.display = 'none';
        el('admin-panel').style.display = 'block';
        
        // 登录成功后自动查询数据
        await query();
        
      } catch (err) {
        el('login-msg').innerHTML = `<span style="color: red;">登录异常：${err.message}</span>`;
      }
    });

    async function query() {
      console.log('开始查询预约数据...');
      
      // 检查登录状态
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if (userError || !user) {
        console.error('用户未登录:', userError);
        el('rows').innerHTML = '<tr><td colspan="6">请先登录</td></tr>';
        return;
      }
      
      console.log('当前用户:', user.email);
      
      let q = supabase.from('appointments').select('*').order('appointment_time', { ascending: true });
      const status = el('status').value;
      const service = el('service').value.trim();
      const start = el('start').value; const end = el('end').value;
      if (status) q = q.eq('status', status);
      if (service) q = q.ilike('service', `%${service}%`);
      if (start) q = q.gte('appointment_time', new Date(start).toISOString());
      if (end) q = q.lte('appointment_time', new Date(end).toISOString());
      const { data, error } = await q;
      console.log('查询结果:', { data, error });
      const tbody = el('rows'); tbody.innerHTML = '';
      if (error) { 
        console.error('查询错误:', error);
        tbody.innerHTML = `<tr><td colspan="7">查询失败：${error.message}</td></tr>`; 
        return; 
      }
      if (!data || data.length === 0) { 
        console.log('没有数据');
        tbody.innerHTML = `<tr><td colspan="7">暂无数据</td></tr>`; 
        return; 
      }
      console.log(`找到 ${data.length} 条预约记录`);
      for (const a of data) {
        console.log('处理预约:', a);
        const tr = document.createElement('tr');
        const availableActions = getAvailableActions(a.status);
        
        tr.innerHTML = `
          <td>${a.customer_name}</td>
          <td>${a.phone}</td>
          <td>${a.service}</td>
          <td>${fmt(a.appointment_time)}</td>
          <td>
            <select data-id="${a.id}" class="status-select">
              ${['pending','confirmed','in_progress','completed','cancelled'].map(s => `<option value="${s}" ${s===a.status?'selected':''}>${getStatusText(s)}</option>`).join('')}
            </select>
          </td>
          <td>${a.notes || '无备注'}</td>
          <td>
            <div class="action-buttons">
              ${availableActions.includes('confirmed') ? `<button class="action-btn confirm" data-id="${a.id}" data-action="confirm">确认预约</button>` : ''}
              ${availableActions.includes('in_progress') ? `<button class="action-btn start" data-id="${a.id}" data-action="start">开始服务</button>` : ''}
              ${availableActions.includes('completed') ? `<button class="action-btn complete" data-id="${a.id}" data-action="complete">完成服务</button>` : ''}
              ${availableActions.includes('cancelled') ? `<button class="action-btn cancel" data-id="${a.id}" data-action="cancel">取消预约</button>` : ''}
            </div>
          </td>
          <td class="right">
            <button class="btn" data-id="${a.id}" data-action="save">保存</button>
          </td>`;
        tbody.appendChild(tr);
      }

      // 保存按钮事件
      tbody.querySelectorAll('button[data-action="save"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const sel = tbody.querySelector(`select.status-select[data-id="${id}"]`);
          const status = sel.value;
          btn.disabled = true; btn.textContent = '保存中...';
          const { error } = await supabase.from('appointments').update({ status }).eq('id', id);
          btn.disabled = false; btn.textContent = '保存';
          if (error) alert('更新失败：' + error.message);
        });
      });
      
      // 工作流程操作按钮事件
      tbody.querySelectorAll('button[data-action="confirm"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          await updateAppointmentStatus(id, 'pending', 'confirmed', 'confirm');
        });
      });
      
      tbody.querySelectorAll('button[data-action="start"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          await updateAppointmentStatus(id, 'confirmed', 'in_progress', 'start');
        });
      });
      
      tbody.querySelectorAll('button[data-action="complete"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          await updateAppointmentStatus(id, 'in_progress', 'completed', 'complete');
        });
      });
      
      tbody.querySelectorAll('button[data-action="cancel"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const currentStatus = btn.closest('tr').querySelector('.status-select').value;
          await updateAppointmentStatus(id, currentStatus, 'cancelled', 'cancel');
        });
      });
    }

    // 更新预约状态
    async function updateAppointmentStatus(appointmentId, fromStatus, toStatus, actionType) {
      try {
        // 更新预约状态
        const { error: updateError } = await supabase
          .from('appointments')
          .update({ status: toStatus })
          .eq('id', appointmentId);
        
        if (updateError) {
          alert('状态更新失败：' + updateError.message);
          return;
        }
        
        // 记录操作历史
        await recordOperation(appointmentId, actionType, fromStatus, toStatus);
        
        // 刷新数据
        await query();
        await loadStatistics();
        
        alert(`操作成功：${getStatusText(fromStatus)} → ${getStatusText(toStatus)}`);
        
      } catch (err) {
        console.error('更新状态异常:', err);
        alert('操作失败：' + err.message);
      }
    }
    
    // 加载统计数据
    async function loadStatistics() {
      try {
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
        
        const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString();
        const monthStart = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString();
        
        // 今日工作：今日所有预约（包括所有状态）
        const { count: todayWorkCount } = await supabase
          .from('appointments')
          .select('*', { count: 'exact', head: true })
          .gte('created_at', todayStart)
          .lt('created_at', todayEnd);
        
        // 本周完成：本周状态为completed的预约
        const { count: weekCompletedCount } = await supabase
          .from('appointments')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'completed')
          .gte('updated_at', weekStart);
        
        // 本月完成：本月状态为completed的预约
        const { count: monthCompletedCount } = await supabase
          .from('appointments')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'completed')
          .gte('updated_at', monthStart);
        
        el('today-stats').textContent = todayWorkCount || 0;
        el('week-stats').textContent = weekCompletedCount || 0;
        el('month-stats').textContent = monthCompletedCount || 0;
        
        console.log('统计数据加载完成:', {
          todayWork: todayWorkCount,
          weekCompleted: weekCompletedCount,
          monthCompleted: monthCompletedCount
        });
        
      } catch (err) {
        console.error('加载统计失败:', err);
      }
    }
    
    // 筛选功能
    async function filterAppointments(filterType, period) {
      try {
        const now = new Date();
        let query = supabase.from('appointments').select('*');
        
        if (filterType === 'today') {
          // 今日工作：显示今日所有预约
          const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
          const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
          query = query.gte('created_at', todayStart).lt('created_at', todayEnd);
        } else if (filterType === 'completed') {
          // 完成预约：显示指定时间段内完成的预约
          query = query.eq('status', 'completed');
          if (period === 'week') {
            const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString();
            query = query.gte('updated_at', weekStart);
          } else if (period === 'month') {
            const monthStart = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString();
            query = query.gte('updated_at', monthStart);
          }
        }
        
        const { data, error } = await query.order('created_at', { ascending: false });
        
        if (error) {
          console.error('筛选失败:', error);
          return;
        }
        
        // 显示筛选结果
        displayFilteredAppointments(data, filterType, period);
        
      } catch (err) {
        console.error('筛选异常:', err);
      }
    }
    
    // 显示筛选结果
    function displayFilteredAppointments(data, filterType, period) {
      const tbody = el('rows');
      tbody.innerHTML = '';
      
      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8">没有找到相关预约</td></tr>`;
        return;
      }
      
      // 显示筛选提示
      let filterMessage = '';
      if (filterType === 'today') {
        filterMessage = `显示今日所有预约 (${data.length}条)`;
      } else if (filterType === 'completed') {
        if (period === 'week') {
          filterMessage = `显示本周完成的预约 (${data.length}条)`;
        } else if (period === 'month') {
          filterMessage = `显示本月完成的预约 (${data.length}条)`;
        }
      }
      
      // 在表格上方显示筛选提示
      showFilterMessage(filterMessage);
      
      // 渲染预约数据
      for (const a of data) {
        const tr = document.createElement('tr');
        const availableActions = getAvailableActions(a.status);
        
        tr.innerHTML = `
          <td>${a.customer_name}</td>
          <td>${a.phone}</td>
          <td>${a.service}</td>
          <td>${fmt(a.appointment_time)}</td>
          <td>
            <select data-id="${a.id}" class="status-select">
              ${['pending','confirmed','in_progress','completed','cancelled'].map(s => `<option value="${s}" ${s===a.status?'selected':''}>${getStatusText(s)}</option>`).join('')}
            </select>
          </td>
          <td>${a.notes || '无备注'}</td>
          <td>
            <div class="action-buttons">
              ${availableActions.includes('confirmed') ? `<button class="action-btn confirm" data-id="${a.id}" data-action="confirm">确认预约</button>` : ''}
              ${availableActions.includes('in_progress') ? `<button class="action-btn start" data-id="${a.id}" data-action="start">开始服务</button>` : ''}
              ${availableActions.includes('completed') ? `<button class="action-btn complete" data-id="${a.id}" data-action="complete">完成服务</button>` : ''}
              ${availableActions.includes('cancelled') ? `<button class="action-btn cancel" data-id="${a.id}" data-action="cancel">取消预约</button>` : ''}
            </div>
          </td>
          <td class="right">
            <button class="btn" data-id="${a.id}" data-action="save">保存</button>
          </td>`;
        tbody.appendChild(tr);
      }
      
      // 绑定事件
      bindAppointmentEvents(tbody);
    }
    
    // 显示筛选提示
    function showFilterMessage(message) {
      // 创建或更新筛选提示
      let filterDiv = document.getElementById('filter-message');
      if (!filterDiv) {
        filterDiv = document.createElement('div');
        filterDiv.id = 'filter-message';
        filterDiv.style.cssText = `
          margin: 16px 0;
          padding: 12px 20px;
          background: var(--glass-bg);
          backdrop-filter: blur(10px);
          border: 1px solid var(--glass-border);
          border-radius: 12px;
          color: var(--text-primary);
          font-weight: 500;
          display: flex;
          justify-content: space-between;
          align-items: center;
        `;
        
        const tableCard = document.querySelector('.card:last-child');
        tableCard.parentNode.insertBefore(filterDiv, tableCard);
      }
      
      filterDiv.innerHTML = `
        <span>${message}</span>
        <button id="clear-filter" class="btn" style="padding: 8px 16px; font-size: 14px;">清除筛选</button>
      `;
      
      // 绑定清除筛选事件
      document.getElementById('clear-filter').addEventListener('click', () => {
        filterDiv.remove();
        query(); // 重新加载所有数据
      });
    }
    
    // 绑定预约事件
    function bindAppointmentEvents(tbody) {
      // 保存按钮事件
      tbody.querySelectorAll('button[data-action="save"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const sel = tbody.querySelector(`select.status-select[data-id="${id}"]`);
          const status = sel.value;
          btn.disabled = true; btn.textContent = '保存中...';
          const { error } = await supabase.from('appointments').update({ status }).eq('id', id);
          btn.disabled = false; btn.textContent = '保存';
          if (error) alert('更新失败：' + error.message);
        });
      });
      
      // 工作流程操作按钮事件
      tbody.querySelectorAll('button[data-action="confirm"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          await updateAppointmentStatus(id, 'pending', 'confirmed', 'confirm');
        });
      });
      
      tbody.querySelectorAll('button[data-action="start"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          await updateAppointmentStatus(id, 'confirmed', 'in_progress', 'start');
        });
      });
      
      tbody.querySelectorAll('button[data-action="complete"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          await updateAppointmentStatus(id, 'in_progress', 'completed', 'complete');
        });
      });
      
      tbody.querySelectorAll('button[data-action="cancel"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const currentStatus = btn.closest('tr').querySelector('.status-select').value;
          await updateAppointmentStatus(id, currentStatus, 'cancelled', 'cancel');
        });
      });
    }
    
    el('btn-search').addEventListener('click', query);
    el('btn-refresh-stats').addEventListener('click', loadStatistics);
    
    // 统计卡片点击事件
    el('today-stats').addEventListener('click', () => {
      console.log('点击今日工作统计');
      filterAppointments('today');
    });
    
    el('week-stats').addEventListener('click', () => {
      console.log('点击本周完成统计');
      filterAppointments('completed', 'week');
    });
    
    el('month-stats').addEventListener('click', () => {
      console.log('点击本月完成统计');
      filterAppointments('completed', 'month');
    });
    
    // 页面加载完成后自动执行登录
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('页面加载完成，开始自动登录...');
      await autoLogin();
    });
    
    // 备用：如果DOMContentLoaded没有触发，使用window.onload
    window.addEventListener('load', async () => {
      console.log('窗口加载完成，检查是否需要自动登录...');
      if (el('loading-card').style.display !== 'none') {
        await autoLogin();
      }
    });
  </script>
</body>
</html>
